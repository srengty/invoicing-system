import{_ as O}from"./GuestLayout-BfdKZXvL.js";import{n as E,u as P,c as h,r as W,a as k,o as J,b as Q,d as b,e as u,f as s,g as r,m as G,h as m,i as n,j as c,p as L,q as g,k as p,t as i,l as X,v as f,y as Z,F as ee,W as $}from"./app-DZTdZYTv.js";import{s as te,a as ae}from"./index-5ekTLqzM.js";import re from"./PaymentSchedule-Dqf4-2Xw.js";import{s as ne}from"./index-B3UDJwyl.js";import se from"./PopupAddPaymentSchedule-gbYfWF0R.js";import{h as D}from"./moment-C5S46NFB.js";import{c as oe,s as le,a as me}from"./AddPayment-C9NM6DBV.js";import{s as U}from"./index-B9Lb2ArG.js";import{s as w}from"./index-DmsJMzp3.js";import{a as ue,s as Y}from"./index-BFVOh3Gg.js";import{s as z}from"./index-CSVV4lvc.js";import{s as ie}from"./index-DSwMawXR.js";/* empty css                                                    */import"./index-Ch5aU8qY.js";import"./index-DRzkQ_aZ.js";import"./index-Dm6_jG8z.js";import"./index-BkHZy9nH.js";import"./index-CHXn2h8A.js";const de={class:"create-agreement flex flex-row gap-4"},ce={class:"border border-gray-200 rounded-lg p-4 w-2/5"},pe={class:"grid grid-cols-2 gap-1 items-center"},ge={alt:"Agreement doc",class:"w-full col-span-2"},fe=["href"],_e={class:"border border-gray-200 rounded-lg p-4 w-2/5"},ye={class:"grid grid-cols-2 gap-1 items-center"},ve={class:"border border-gray-200 rounded-lg p-4"},he={class:"grid grid-cols-1 gap-1"},be={key:0,class:"flex justify-end items-center gap-2 my-2 px-24"},Te={__name:"CreateForm",props:{errors:Object,customers:Array,agreement_max:Number,agreement:Object,edit:Boolean},setup(o){const A=E(),l=o,S=P(),_=h({get:()=>a.currency=="KHR",set:t=>{a.currency=t?"KHR":"USD",d.value.agreement_currency=a.currency}}),a=W({quotation_no:null,agreement_no:null,agreement_date:new Date,customer_id:null,address:null,agreement_doc:null,progress:null,start_date:new Date,end_date:new Date,agreement_amount:10,short_description:"",attachments:[],payment_schedule:[],attachments:null,currency:"KHR"}),d=k({agreement_amount:a.agreement_amount,due_date:new Date,short_description:"Item description",percentage:100,remark:"Additional remark",amount:2e3,currency:"KHR",agreement_currency:"KHR",exchange_rate:4200}),q=h(()=>d.value.agreement_amount-a.payment_schedule.reduce((t,e)=>t+e.amount,0)),V=h(()=>100-a.payment_schedule.reduce((t,e)=>t+e.percentage,0)),x=k(!1),C=h(()=>a.payment_schedule.some(t=>t.currency!=a.currency)),M=({values:t})=>{const e={customer_id:[],agreement_amount:[]};return t.customer_id||e.customer_id.push({type:"required",message:"customer_id is required."}),t.agreement_amount||e.agreement_amount.push({type:"required",message:"agreement_amount is required."}),t.agreement_amount<=10&&e.agreement_amount.push({type:"minimum",message:"agreement_amount must be at least 10."}),{errors:e}};J(()=>{a.agreement_no=l.agreement_max,l.edit&&(console.log("edit",l.agreement),a.quotation_no=l.agreement.quotation_no,a.agreement_no=l.agreement.agreement_no,a.agreement_date=D(l.agreement.agreement_date,"DD/MM/YYYY").toDate(),a.customer_id=l.agreement.customer_id,a.address=l.agreement.address,a.agreement_doc=l.agreement.agreement_doc,a.start_date=D(l.agreement.start_date,"DD/MM/YYYY").toDate(),a.end_date=D(l.agreement.end_date,"DD/MM/YYYY").toDate(),a.agreement_amount=l.agreement.amount,a.short_description=l.agreement.short_description,a.payment_schedule=l.agreement.payment_schedules,a.attachments=JSON.parse(l.agreement.attachments??"[]"),a.currency=l.agreement.currency,_.value=l.agreement.currency=="KHR",d.value.agreement_amount=l.agreement.amount)});const N=({states:t,valid:e})=>{x.value=!0,a.agreement_amount=d.value.agreement_amount,console.log("submit",t,e),l.edit?(a._method="PUT",$.put(route("agreements.update",l.agreement.agreement_no),a)):$.post(route("agreements.store"),a),x.value=!1},B=t=>{console.log(t),S.add({severity:"success",summary:"Success",detail:"File Uploaded"+t.files[0],life:3e3}),a.agreement_doc=t.xhr.responseText,y.value=t.xhr.responseText},F=t=>{console.log(t),S.add({severity:"success",summary:"Success",detail:"File Uploaded"+t.files[0],life:3e3}),a.attachments||(a.attachments=[]),a.attachments.push(t.xhr.responseText)},H=t=>{t.formData.enctype="multipart/form-data",t.formData.append("agreement_doc_old",a.agreement_doc),t.formData.append("_token",A.props.csrf_token)},K=t=>{t.formData.enctype="multipart/form-data",t.formData.append("_token",A.props.csrf_token)},y=k(null),R=t=>{d.value.currency=t.currency,a.payment_schedule.push({id:a.payment_schedule.length+1,due_date:t.due_date,short_description:t.short_description,percentage:t.percentage,currency:t.currency,remark:t.remark,amount:t.amount})},T=t=>{d.value.amount=q.value,d.value.percentage=V.value};return(t,e)=>{const j=Q("tooltip");return u(),b(ee,null,[s(r(G),{title:"Create Agreement"}),s(O,null,{default:m(()=>[e[15]||(e[15]=n("h1",{class:"text-2xl"},"Create Agreement",-1)),s(r(te),{onSubmit:N,action:t.route("agreements.store"),"initial-values":a,resolver:M},{default:m(xe=>[n("div",de,[n("div",ce,[n("div",pe,[L((u(),b("span",null,e[2]||(e[2]=[p("Quotation No.")]))),[[j,"must be approved and no agreement attached"]]),s(r(U),{name:"quotation_no","use-grouping":!1,class:"w-full"}),n("span",null,"Agreement No. "+i(o.agreement_max),1),s(r(U),{name:"agreement_no",class:X(o.errors.agreement_no?"p-invalid":""),"use-grouping":!1,readonly:!0},null,8,["class"]),o.errors.agreement_no?(u(),g(r(f),{key:0,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.agreement_no),1)]),_:1})):c("",!0),e[4]||(e[4]=n("span",null,"Date",-1)),s(r(w),{"date-format":"dd/mm/yy",name:"agreement_date",showIcon:""}),o.errors.date?(u(),g(r(f),{key:1,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.date),1)]),_:1})):c("",!0),e[5]||(e[5]=n("span",null,"Customer",-1)),s(r(ue),{filter:"",options:o.customers,"option-value":"id",name:"customer_id","option-label":"name",virtualScrollerOptions:{itemSize:38}},null,8,["options"]),o.errors.customer_id?(u(),g(r(f),{key:2,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.customer_id),1)]),_:1})):c("",!0),e[6]||(e[6]=n("span",null,"Address",-1)),s(r(Y),{name:"address"}),o.errors.address?(u(),g(r(f),{key:3,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.address),1)]),_:1})):c("",!0),e[7]||(e[7]=n("span",null,"Agreement doc",-1)),s(r(z),{name:"agreement_doc",auto:"",onBeforeUpload:H,mode:"basic",url:t.route("agreements.upload"),accept:"application/pdf",maxFileSize:1e6,onUpload:B},null,8,["url"]),o.errors.agreement_doc?(u(),g(r(f),{key:4,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.agreement_doc),1)]),_:1})):c("",!0),n("span",ge,[y.value?(u(),b("a",{key:0,class:"underline hover:text-red-800",href:y.value,target:"_blank"},[e[3]||(e[3]=n("i",{class:"pi pi-file-pdf"},null,-1)),p(" "+i(y.value.split("/").pop()),1)],8,fe)):c("",!0)])])]),n("div",_e,[n("div",ye,[e[8]||(e[8]=n("span",{class:"col-span-2 text-xl mb-5"},"Agreement summary",-1)),e[9]||(e[9]=n("span",null,"Start date",-1)),s(r(w),{"date-format":"dd/mm/yy",name:"start_date",showIcon:""}),o.errors.start_date?(u(),g(r(f),{key:0,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.start_date),1)]),_:1})):c("",!0),e[10]||(e[10]=n("span",null,"End date",-1)),s(r(w),{"date-format":"dd/mm/yy",name:"end_date",showIcon:""}),o.errors.end_date?(u(),g(r(f),{key:1,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.end_date),1)]),_:1})):c("",!0),n("span",null,"Agreement amount ("+i(r(oe)[_.value==!0?0:1].name)+")",1),s(r(le),null,{default:m(()=>[s(r(me),null,{default:m(()=>[s(r(ie),{modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=v=>_.value=v)},null,8,["modelValue"])]),_:1}),s(r(U),{name:"agreement_amount"})]),_:1}),o.errors.agreement_amount?(u(),g(r(f),{key:2,severity:"error",size:"small",variant:"simple",class:"col-span-2"},{default:m(()=>[p(i(o.errors.agreement_amount),1)]),_:1})):c("",!0),e[11]||(e[11]=n("span",null,"Short description",-1)),s(r(ne),{name:"short_description",rows:"2"}),e[12]||(e[12]=n("span",null,"Payment schedule",-1)),s(r(ae),{name:"payment_schedule"},{default:m(v=>[s(se,{modelValue:d.value,"onUpdate:modelValue":e[1]||(e[1]=I=>d.value=I),onSave:R,onUpdate:T},null,8,["modelValue"]),n("pre",null,i(v||"null"),1)]),_:1})])]),n("div",ve,[n("div",he,[e[13]||(e[13]=n("span",null,"Attachment",-1)),s(r(z),{name:"attachments",url:t.route("agreements.upload"),auto:"",accept:"application/pdf",onBeforeUpload:K,onUpload:F},null,8,["url"])])])]),s(re,{class:"mt-2",name:"payment_schedule",currency:a.currency,agreement_amount:d.value.agreement_amount},null,8,["currency","agreement_amount"]),C.value?(u(),b("div",be,[e[14]||(e[14]=n("label",{for:"agreement_exchange_rate",class:"required"},"Exchange rate",-1)),s(r(Y),{id:"agreement_exchange_rate",name:"exchange_rate"})])):c("",!0),s(r(Z),{label:"Save",type:"submit",disabled:x.value},null,8,["disabled"])]),_:1},8,["action","initial-values"])]),_:1})],64)}}};export{Te as default};
