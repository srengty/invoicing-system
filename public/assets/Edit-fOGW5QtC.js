import{u as te,n as ae,c as v,C as re,a as x,b as se,d as g,e as p,f as l,g as a,m as ne,h as d,i as n,P as oe,j as w,k as q,l as le,t as _,s as me,q as de,p as k,v as ue,F as S,x as C,y as M}from"./app-DZTdZYTv.js";import{_ as ie}from"./GuestLayout-BfdKZXvL.js";import{N as ce}from"./NavbarLayout-Bz1XHzsh.js";import{s as pe}from"./index-5ekTLqzM.js";import{s as ge}from"./index-m66pCNzn.js";import ye from"./PaymentSchedule-Dqf4-2Xw.js";import fe from"./PopupAddPaymentSchedule-gbYfWF0R.js";import{c as _e,s as ve,a as xe}from"./AddPayment-C9NM6DBV.js";import{h}from"./moment-C5S46NFB.js";import{s as V}from"./index-BFVOh3Gg.js";import{s as O}from"./index-B9Lb2ArG.js";import{s as $}from"./index-DmsJMzp3.js";import{s as P}from"./index-CSVV4lvc.js";import{s as B}from"./index-C7E1Y1rv.js";import{s as be}from"./index-DSwMawXR.js";import{s as he}from"./index-B3UDJwyl.js";/* empty css                                                    */import"./index-Ch5aU8qY.js";import"./index-DRzkQ_aZ.js";import"./index-Dm6_jG8z.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-BkHZy9nH.js";import"./index-CHXn2h8A.js";const Ve={class:"py-3"},De={class:"edit-agreement pl-4 pr-4"},Ae={class:"flex flex-row justify-between gap-4"},Ue={class:"border border-gray-200 rounded-lg p-4 w-1/2"},we={class:"grid grid-cols-2 gap-2 items-center"},ke={key:0,class:"pi pi-exclamation-triangle text-yellow-500"},Se={class:"grid gap-3 w-full"},$e={class:"text-sm font-medium text-gray-700 mr-3"},Ne=["href"],ze={class:"border border-gray-200 rounded-lg p-4 w-1/2"},Ye={class:"grid grid-cols-2 gap-2 items-center"},Ee={class:"text-sm"},Fe={class:"border border-gray-200 rounded-lg p-4 w-1/3"},Re={class:"space-y-4"},qe={class:"space-y-2"},Ce={class:"text-xs font-medium text-gray-700 mr-3"},Me={class:"flex items-center gap-2"},Oe=["href"],Pe=["onClick"],ut={__name:"Edit",props:{agreement:Object,customers:Array,quotations:Array,errors:Object},setup(N){var F,R;const y=te(),z=ae(),o=N,J=v(()=>[{label:"",to:"/",icon:"pi pi-home"},{label:"Agreements",to:route("agreements.index")},{label:`Edit Agreement ${o.agreement.agreement_no}`,to:route("agreements.edit",{agreement_no:o.agreement.agreement_no})}]),r=re({quotation_no:o.agreement.quotation_no,agreement_no:o.agreement.agreement_no,agreement_reference_no:o.agreement.agreement_reference_no,agreement_date:o.agreement.agreement_date?h(o.agreement.agreement_date,"DD/MM/YYYY").toDate():new Date,customer_id:o.agreement.customer_id,address:o.agreement.address,agreement_doc:o.agreement.agreement_doc?JSON.parse(o.agreement.agreement_doc):null,start_date:o.agreement.start_date?h(o.agreement.start_date,"DD/MM/YYYY").toDate():new Date,end_date:o.agreement.end_date?h(o.agreement.end_date,"DD/MM/YYYY").toDate():new Date,agreement_amount:o.agreement.amount,short_description:o.agreement.short_description,currency:o.agreement.currency||"USD",attachments:o.agreement.attachments?JSON.parse(o.agreement.attachments):[],payment_schedule:((F=o.agreement.payment_schedules)==null?void 0:F.map(t=>({id:t.id,due_date:t.due_date?h(t.due_date,"DD/MM/YYYY").toDate():new Date,short_description:t.short_description,percentage:t.percentage,currency:t.currency,remark:t.remark,amount:t.amount,status:t.status||"Pending",agreement_currency:o.agreement.currency,exchange_rate:t.exchange_rate||(t.currency==="KHR"?4100:1)})))||[]}),D=x(!1),Y=x(((R=o.agreement.customer)==null?void 0:R.name)||""),b=x(!1),A=v({get:()=>r.currency==="KHR",set:t=>{r.currency=t?"KHR":"USD",r.currency==="KHR"?u.value.exchange_rate=4100:u.value.exchange_rate=1}}),u=x({agreement_amount:o.agreement.amount,due_date:new Date,short_description:"Item description",percentage:100,remark:"Additional remark",amount:o.agreement.amount,currency:o.agreement.currency||"USD",agreement_currency:o.agreement.currency||"USD",exchange_rate:o.agreement.currency==="KHR"?4100:1}),E=Array.isArray(o.agreement.agreement_doc)?o.agreement.agreement_doc:JSON.parse(o.agreement.agreement_doc||"[]"),f=x(E);r.agreement_doc=E;const T=v(()=>u.value.agreement_amount-r.payment_schedule.reduce((t,e)=>t+e.amount,0)),j=v(()=>100-r.payment_schedule.reduce((t,e)=>t+e.percentage,0));v(()=>r.payment_schedule.some(t=>t.currency!=r.currency));const H=t=>{t.formData.append("_token",z.props.csrf_token)},K=t=>{t.formData.append("_token",z.props.csrf_token)},I=t=>{try{const e=JSON.parse(t.xhr.responseText),m=Array.isArray(e)?e:[e];m.forEach(s=>{const i={path:s.path,name:s.name,size:s.size,mime_type:s.mime_type};f.value.push(i)}),r.agreement_doc=[...f.value],y.add({severity:"success",summary:"Uploaded",detail:`${m.length} agreement document(s) uploaded successfully`,life:3e3})}catch(e){console.error("Upload error:",e),y.add({severity:"error",summary:"Error",detail:"Failed to upload agreement document(s)",life:3e3})}},L=t=>{f.value.splice(t,1),r.agreement_doc=[...f.value],y.add({severity:"info",summary:"Removed",detail:"Agreement document has been removed",life:3e3})},Q=t=>{try{const e=JSON.parse(t.xhr.responseText);r.attachments.push({path:e.path,name:e.name,size:e.size,type:e.mime_type}),y.add({severity:"success",summary:"Uploaded",detail:`Attachment "${e.name}" added successfully`,life:3e3})}catch{y.add({severity:"error",summary:"Error",detail:"Failed to upload attachment",life:3e3})}},G=t=>{r.attachments.splice(t,1),y.add({severity:"info",summary:"Removed",detail:"Attachment has been removed",life:3e3})},W=t=>{u.value.currency=t.currency,r.payment_schedule.push({id:r.payment_schedule.length+1,due_date:t.due_date,short_description:t.short_description,percentage:t.percentage,currency:t.currency,remark:t.remark,amount:t.amount,status:t.status??"Pending",agreement_currency:r.currency,exchange_rate:t.currency==="KHR"?4100:1})},X=t=>{u.value.amount=T.value,u.value.percentage=j.value},Z=async()=>{if(!r.agreement_reference_no){b.value=!1;return}try{const t=await axios.get("/api/check-agreement-reference",{params:{reference_no:r.agreement_reference_no,exclude_id:o.agreement.id}});b.value=t.data.exists}catch(t){console.error("Error checking reference:",t)}},ee=()=>{D.value=!0;const t=m=>{if(!m)return null;const s=m instanceof Date?m:new Date(m),i=String(s.getDate()).padStart(2,"0"),c=String(s.getMonth()+1).padStart(2,"0"),U=s.getFullYear();return`${i}/${c}/${U}`},e={...r.data(),agreement_amount:u.value.agreement_amount,agreement_doc:f.value.length>0?JSON.stringify(f.value):null,agreement_date:t(r.agreement_date),start_date:t(r.start_date),end_date:t(r.end_date),payment_schedule:r.payment_schedule.map(m=>({...m,due_date:t(m.due_date),amount:parseFloat(m.amount),percentage:parseFloat(m.percentage)})),attachments:r.attachments.length>0?JSON.stringify(r.attachments):null};console.log("Formatted data before submission:",e),r.transform(()=>({...e,_method:"PUT"})).post(route("agreements.update",{agreement_no:o.agreement.agreement_no}),{preserveScroll:!0,onSuccess:()=>{y.add({severity:"success",summary:"Success",detail:"Agreement updated successfully",life:3e3})},onError:m=>{console.error("Validation errors:",m)},onFinish:()=>{D.value=!1}})};return(t,e)=>{const m=se("tooltip");return p(),g(S,null,[l(a(ne),{title:`Edit Agreement ${N.agreement.agreement_no}`},null,8,["title"]),l(ie,null,{default:d(()=>[l(ce),n("div",Ve,[l(a(ge),{model:J.value,class:"border-none bg-transparent p-0"},{item:d(({item:s})=>[l(a(oe),{href:s.to,class:"text-sm hover:text-primary flex items-start justify-center gap-1"},{default:d(()=>[s.icon?(p(),g("i",{key:0,class:le(s.icon)},null,2)):w("",!0),q(" "+_(s.label),1)]),_:2},1032,["href"])]),_:1},8,["model"])]),n("div",De,[l(a(me)),l(a(pe),{onSubmit:ee,"initial-values":a(r),class:"mt-6"},{default:d(()=>[n("div",Ae,[n("div",Ue,[n("div",we,[e[17]||(e[17]=n("span",{class:"col-span-2 text-xl font-semibold mb-5"},"Record Agreement",-1)),e[18]||(e[18]=n("span",{class:"text-sm"},"Quotation No.",-1)),l(a(V),{modelValue:a(r).quotation_no,"onUpdate:modelValue":e[0]||(e[0]=s=>a(r).quotation_no=s),placeholder:"Enter Quotation No.",class:"w-full",size:"small",readonly:""},null,8,["modelValue"]),e[19]||(e[19]=n("span",{class:"text-sm required"},"Agreement No.",-1)),l(a(O),{modelValue:a(r).agreement_no,"onUpdate:modelValue":e[1]||(e[1]=s=>a(r).agreement_no=s),name:"agreement_no","use-grouping":!1,readonly:!0,size:"small"},null,8,["modelValue"]),e[20]||(e[20]=n("span",{class:"text-sm"},"Agreement reference No.",-1)),l(a(V),{modelValue:a(r).agreement_reference_no,"onUpdate:modelValue":e[2]||(e[2]=s=>a(r).agreement_reference_no=s),placeholder:"Enter reference number",class:"w-full",size:"small",onBlur:Z},{suffix:d(()=>[b.value?k((p(),g("i",ke,null,512)),[[m,"This reference number already exists!"]]):w("",!0)]),_:1},8,["modelValue"]),b.value?(p(),de(a(ue),{key:0,severity:"warn",variant:"simple",class:"col-span-2",size:"small"},{default:d(()=>e[13]||(e[13]=[q("This reference number already exists in our records")])),_:1})):w("",!0),e[21]||(e[21]=n("span",{class:"text-sm required"},"Date",-1)),l(a($),{"date-format":"dd/mm/yy",name:"agreement_date",modelValue:a(r).agreement_date,"onUpdate:modelValue":e[3]||(e[3]=s=>a(r).agreement_date=s),showIcon:"",size:"small"},null,8,["modelValue"]),e[22]||(e[22]=n("span",{class:"text-sm required"},"Customer name",-1)),l(a(V),{name:"customer_name",modelValue:Y.value,"onUpdate:modelValue":e[4]||(e[4]=s=>Y.value=s),size:"small",readonly:""},null,8,["modelValue"]),e[23]||(e[23]=n("span",{class:"text-sm"},"Address",-1)),l(a(V),{name:"address",modelValue:a(r).address,"onUpdate:modelValue":e[5]||(e[5]=s=>a(r).address=s),size:"small",readonly:""},null,8,["modelValue"]),e[24]||(e[24]=n("span",{class:"text-sm required"},"Agreement doc",-1)),l(a(P),{name:"agreement_doc",url:t.route("agreements.upload"),mode:"basic",auto:"",accept:"application/pdf",multiple:"",onBeforeUpload:H,onUpload:I,chooseLabel:"Upload Agreement PDF",class:"custom-file-upload w-full h-9"},{chooseicon:d(()=>e[14]||(e[14]=[n("i",{class:"pi pi-file-pdf"},null,-1)])),_:1},8,["url"]),l(a(B),{value:f.value,class:"col-span-2 mt-2"},{list:d(s=>[n("div",Se,[(p(!0),g(S,null,C(s.items,(i,c)=>(p(),g("div",{key:c,class:"border border-gray-200 rounded-lg p-3 flex items-center hover:bg-gray-50 transition-colors"},[n("span",$e," Agreement Doc "+_(c+1)+": ",1),e[15]||(e[15]=n("i",{class:"pi pi-file-pdf mr-2 text-red-500"},null,-1)),n("a",{class:"hover:underline hover:text-blue-600 flex items-center text-blue-500",href:i.path,target:"_blank"},_(i.name||"document.pdf"),9,Ne),k(l(a(M),{onClick:U=>L(c),icon:"pi pi-times",text:"",rounded:"",severity:"danger",class:"ml-auto hover:bg-red-50"},null,8,["onClick"]),[[m,"Remove document"]])]))),128))])]),empty:d(()=>e[16]||(e[16]=[n("div",{class:"text-center p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50"},[n("i",{class:"pi pi-inbox text-2xl text-gray-400 mb-2"}),n("p",{class:"text-gray-500"}," No agreement document uploaded ")],-1)])),_:1},8,["value"])])]),n("div",ze,[n("div",Ye,[e[25]||(e[25]=n("span",{class:"col-span-2 font-semibold text-xl mb-5"},"Agreement summary",-1)),e[26]||(e[26]=n("span",{class:"text-sm"},"Start date",-1)),l(a($),{"date-format":"dd/mm/yy",name:"start_date",modelValue:a(r).start_date,"onUpdate:modelValue":e[6]||(e[6]=s=>a(r).start_date=s),showIcon:"",size:"small"},null,8,["modelValue"]),e[27]||(e[27]=n("span",{class:"text-sm"},"End date",-1)),l(a($),{"date-format":"dd/mm/yy",name:"end_date",modelValue:a(r).end_date,"onUpdate:modelValue":e[7]||(e[7]=s=>a(r).end_date=s),showIcon:"",size:"small"},null,8,["modelValue"]),n("span",Ee," Agreement amount ("+_(a(_e)[A.value?1:0].name)+") ",1),l(a(ve),{size:"small"},{default:d(()=>[l(a(xe),null,{default:d(()=>[l(a(be),{modelValue:A.value,"onUpdate:modelValue":e[8]||(e[8]=s=>A.value=s)},null,8,["modelValue"])]),_:1}),l(a(O),{modelValue:u.value.agreement_amount,"onUpdate:modelValue":e[9]||(e[9]=s=>u.value.agreement_amount=s),value:u.value.agreement_amount},null,8,["modelValue","value"])]),_:1}),e[28]||(e[28]=n("span",{class:"text-sm"},"Short description",-1)),l(a(he),{name:"short_description",rows:"2",modelValue:a(r).short_description,"onUpdate:modelValue":e[10]||(e[10]=s=>a(r).short_description=s),size:"small"},null,8,["modelValue"]),e[29]||(e[29]=n("span",{class:"text-sm"},"Payment schedule",-1)),l(fe,{modelValue:u.value,"onUpdate:modelValue":e[11]||(e[11]=s=>u.value=s),onSave:W,onUpdate:X,size:"small",class:"w-full"},null,8,["modelValue"])])]),n("div",Fe,[e[35]||(e[35]=n("h3",{class:"font-semibold text-xl mb-4"},"Attachments",-1)),n("div",Re,[e[34]||(e[34]=n("span",{class:"text-sm required"},"Add Attachment",-1)),l(a(P),{name:"attachments",url:t.route("agreements.upload"),mode:"basic",auto:"",multiple:"",accept:"application/pdf",onBeforeUpload:K,onUpload:Q,chooseLabel:"Upload Attachments",class:"custom-file-upload w-full h-9"},{chooseicon:d(()=>e[30]||(e[30]=[n("i",{class:"pi pi-paperclip mr-2"},null,-1)])),_:1},8,["url"]),l(a(B),{value:a(r).attachments,class:"w-full"},{list:d(s=>[n("div",qe,[(p(!0),g(S,null,C(s.items,(i,c)=>(p(),g("div",{key:c,class:"flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"},[n("span",Ce," Attachment:"+_(c+1),1),n("div",Me,[e[31]||(e[31]=n("i",{class:"pi pi-file-pdf text-red-500"},null,-1)),n("a",{class:"text-sm font-medium text-blue-500 hover:underline",href:i.path,target:"_blank"},_(i.name),9,Oe)]),k((p(),g("button",{onClick:U=>G(c),class:"text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50"},e[32]||(e[32]=[n("i",{class:"pi pi-times"},null,-1)]),8,Pe)),[[m,"Remove attachment"]])]))),128))])]),empty:d(()=>e[33]||(e[33]=[n("div",{class:"text-center p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50"},[n("i",{class:"pi pi-inbox text-2xl text-gray-400 mb-2"}),n("p",{class:"text-sm text-gray-500"}," No attachments added ")],-1)])),_:1},8,["value"])])])]),l(ye,{class:"mt-2",modelValue:a(r).payment_schedule,"onUpdate:modelValue":e[12]||(e[12]=s=>a(r).payment_schedule=s),currency:a(r).currency,agreement_amount:u.value.agreement_amount},null,8,["modelValue","currency","agreement_amount"]),l(a(M),{label:"Save Changes",type:"submit",raised:"",class:"w-48 mt-5",disabled:D.value,icon:"pi pi-check"},null,8,["disabled"])]),_:1},8,["initial-values"])])]),_:1})],64)}}};export{ut as default};
